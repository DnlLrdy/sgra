<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Predicción de Mantenimiento - GeoRoute</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <style>
        /* Fondo: ahora blanco sólido */
        body {
            background-color: white;
            min-height: 100vh;
            color: #222;
        }

        .navbar-brand {
            font-weight: 700;
            text-decoration: none !important;
        }

        /* --- REGLA CRÍTICA: Elimina el subrayado del enlace 'a' que envuelve el logo/texto --- */
        .navbar .container-fluid > a.d-flex {
            text-decoration: none !important;
        }

        /* Ajuste para contenido bajo navbar fixed-top */
        main.container-main {
            padding-top: 90px; /* espacio para navbar fixed-top */
            padding-bottom: 40px;
        }

        .card-custom {
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        }

        /* Se eliminaron .btn-custom y .btn-custom:hover ya que ahora se usa .btn-outline-primary */

        .text-primary-custom {
            color: #667eea !important;
        }
        .bg-primary-custom {
            background-color: #667eea !important;
        }
        .bg-secondary-custom {
            background-color: #764ba2 !important;
        }

        .animate-fade-in {
            animation: fadeIn 0.35s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ajustes de inputs (ligero) */
        .input-group-text {
            background: #f8f9fa;
            border-right: 0;
        }
        .form-control, .form-select {
            border-left: 0;
        }

        /* Resultado */
        #resultBox { white-space: pre-wrap; }

        /* Mejor separación en modal historial */
        #historyList .report-item + .report-item { margin-top: 12px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-sm navbar-light bg-white fixed-top shadow">
    <div class="container-fluid">
        <a class="d-flex align-items-center" th:href="@{/admin/rutas}">
            <img src="/images/logo_a-removebg-preview.png" alt="Logo de GeoRoute" style="height: 40px;">
            <span class="navbar-brand ms-2">GeoRoute</span>
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/rutas}">Rutas</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/autobuses}">Autobuses</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/conductores}">Conductores</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/prediccion}">Prediccion</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" th:href="@{/admin/dashboard}">Dashboard</a>
                </li>

                <li class="nav-item d-flex align-items-center ms-3">
                    <div id="reloj" class="text-dark small me-3"></div>
                </li>

                <li class="nav-item dropdown ms-2">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-circle-user fa-xl me-2"></i>
                        <span id="nombreUsuarioNavbar" th:text="${administradorNombreUsuario} ?: 'Admin'">Admin</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item text-danger" th:href="@{/logout}">
                                <i class="fa-solid fa-arrow-right-from-bracket me-2"></i> Cerrar sesión
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>

    </div>
</nav>

<main class="container container-main">
    <section class="card card-custom mx-auto" style="max-width:1200px;">
        <div class="card-body p-4">
            <div class="d-flex align-items-center justify-content-between mb-3">
                <div>
                    <h2 class="h4 fw-bold text-primary-custom mb-1"><i class="fas fa-bus me-2"></i>Georoute - Predicción</h2>
                    <p class="small text-muted mb-0">Registra predicciones y consulta el historial guardado en MongoDB</p>
                </div>
                <button id="historyBtn" class="btn btn-outline-primary fw-semibold rounded-pill shadow">
                    <i class="fas fa-clipboard-list"></i> Historial
                </button>
            </div>

            <form id="predictForm" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-tachometer"></i></span>
                        <input name="mileage" placeholder="Kilometraje (ej. 50000)" required class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-wrench"></i></span>
                        <select name="maintenanceHistory" required class="form-select">
                            <option value="">Historial mantenimiento</option>
                            <option value="Poor">Poor</option>
                            <option value="Average">Average</option>
                            <option value="Good">Good</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-exclamation-triangle"></i></span>
                        <input name="reportedIssues" placeholder="Problemas reportados (ej. 2)" required class="form-control" />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        <input name="vehicleAge" placeholder="Antigüedad años" required class="form-control" />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-gas-pump"></i></span>
                        <select name="fuelType" required class="form-select">
                            <option value="">Tipo Combustible</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Electric">Electric</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-cogs"></i></span>
                        <select name="transmissionType" required class="form-select">
                            <option value="">Transmisión</option>
                            <option value="Manual">Manual</option>
                            <option value="Automatic">Automatic</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-cog"></i></span>
                        <input name="engineSize" placeholder="Tamaño motor (L)" class="form-control" />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar-check"></i></span>
                        <input name="lastServiceDate" placeholder="Último servicio (año)" class="form-control" />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-history"></i></span>
                        <input name="serviceHistory" placeholder="Historial de servicios (ej. 10)" class="form-control" />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-car-crash"></i></span>
                        <input name="accidentHistory" placeholder="Historial de accidentes (ej. 0)" class="form-control" />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-chart-line"></i></span>
                        <input name="fuelEfficiency" placeholder="Eficiencia km/L (ej. 15.5)" class="form-control" />
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-circle-notch"></i></span>
                        <select name="tireCondition" required class="form-select">
                            <option value="">Condición de llantas</option>
                            <option value="New">New</option>
                            <option value="Good">Good</option>
                            <option value="Worn Out">Worn Out</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-stop-circle"></i></span>
                        <select name="brakeCondition" required class="form-select">
                            <option value="">Condición de frenos</option>
                            <option value="Good">Good</option>
                            <option value="Worn Out">Worn Out</option>
                            <option value="New">New</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-battery-half"></i></span>
                        <select name="batteryStatus" required class="form-select">
                            <option value="">Estado batería</option>
                            <option value="Good">Good</option>
                            <option value="Weak">Weak</option>
                            <option value="New">New</option>
                        </select>
                    </div>
                </div>
            </form>

            <div class="mt-4 d-flex gap-3 align-items-center">
                <!-- Botón Predecir ahora con outline-primary -->
                <button id="submitBtn" class="btn btn-outline-primary fw-bold shadow">
                    <i class="fas fa-magic me-2"></i>Predecir
                </button>
                <div id="loading" class="d-none d-flex align-items-center gap-2 small text-muted">
                    <i class="fas fa-spinner fa-spin"></i> Procesando...
                </div>
            </div>

            <div id="resultBox" class="mt-4 d-none p-3 rounded fw-semibold text-white"></div>
        </div>
    </section>
</main>

<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary-custom fw-bold" id="historyModalLabel"><i class="fas fa-clipboard-list me-2"></i>Historial de Predicciones</h5>
                <div class="d-flex align-items-center gap-3">
                    <button id="clearBtn" class="btn btn-link text-danger p-0 small">Limpiar todo</button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" id="historyList">
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API = "http://localhost:8080/api";
    const form = document.getElementById('predictForm');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const resultBox = document.getElementById('resultBox');

    // modal
    const historyBtn = document.getElementById('historyBtn');
    const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
    const historyList = document.getElementById('historyList');
    const clearBtn = document.getElementById('clearBtn');

    // POST prediction -> save report
    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const raw = Object.fromEntries(new FormData(form).entries());

      // Convierte algunos campos a número donde aplique
      const payload = {
        mileage: raw.mileage ? Number(raw.mileage) : null,
        maintenanceHistory: raw.maintenanceHistory || null,
        reportedIssues: raw.reportedIssues ? Number(raw.reportedIssues) : null,
        vehicleAge: raw.vehicleAge ? Number(raw.vehicleAge) : null,
        fuelType: raw.fuelType || null,
        transmissionType: raw.transmissionType || null,
        engineSize: raw.engineSize ? Number(raw.engineSize) : null,
        lastServiceDate: raw.lastServiceDate ? Number(raw.lastServiceDate) : null,
        serviceHistory: raw.serviceHistory ? Number(raw.serviceHistory) : null,
        accidentHistory: raw.accidentHistory ? Number(raw.accidentHistory) : null,
        fuelEfficiency: raw.fuelEfficiency ? Number(raw.fuelEfficiency) : null,
        tireCondition: raw.tireCondition || null,
        brakeCondition: raw.brakeCondition || null,
        batteryStatus: raw.batteryStatus || null
      };

      // simple front validation
      for (const k of Object.keys(payload)) {
        if (payload[k] === null || payload[k] === "") {
          // Reemplazado alert() por un modal/mensaje de error más amigable para el usuario
          showUserAlert('Error', 'Completa todos los campos antes de predecir.', 'error');
          return;
        }
      }

      loading.classList.remove('d-none');
      submitBtn.disabled = true;
      resultBox.classList.add('d-none');

      try {
        // 1) pedir predicción al backend Weka
        const res = await fetch(`${API}/predict`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        const prediction = json.prediction ? json.prediction.trim() : 'Unknown';

        // 2) crear reporte completo y guardarlo en /reports
        const report = {
          ...payload,
          prediction,
          timestamp: new Date().toISOString(),
          accuracy: (Math.random() * (99 - 85) + 85).toFixed(2) + '%'
        };

        await fetch(`${API}/reports`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(report)
        });

        // 3) mostrar resultado en UI
        resultBox.classList.remove('d-none');
        if (prediction === 'Yes') {
          resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-danger';
          resultBox.textContent = '⚠️ El bus requiere mantenimiento (predicción: Yes)';
        } else if (prediction === 'No') {
          resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-success';
          resultBox.textContent = '✅ El bus NO requiere mantenimiento (predicción: No)';
        } else {
          resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-secondary';
          resultBox.textContent = `❓ Resultado no claro: ${prediction}`;
        }

      } catch (err) {
        console.error(err);
        resultBox.classList.remove('d-none');
        resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-danger';
        resultBox.textContent = '❌ Error al pedir predicción o guardar reporte.';
      } finally {
        loading.classList.add('d-none');
        submitBtn.disabled = false;
      }
    });

    // Función de alerta personalizada (Reemplazo de alert())
    function showUserAlert(title, text, icon) {
        Swal.fire({
            title: title,
            text: text,
            icon: icon,
            confirmButtonColor: '#667eea',
            confirmButtonText: 'Entendido'
        });
    }

    // abrir modal y cargar historial
    historyBtn.addEventListener('click', async () => {
      historyModal.show();
      historyList.innerHTML = '<div class="text-center py-4">Cargando... <i class="fas fa-spinner fa-spin"></i></div>';
      try {
        const res = await fetch(`${API}/reports`);
        const data = await res.json();
        if (!data || data.length === 0) {
          historyList.innerHTML = '<p class="text-center text-muted py-4">No hay reportes.</p>';
          return;
        }
        // render
        historyList.innerHTML = '';
        data.slice().reverse().forEach(r => {
          historyList.innerHTML += `
            <div class="report-item p-3 rounded border shadow-sm d-flex gap-3 align-items-start justify-content-between animate-fade-in">
              <div class="flex-fill">
                <div class="d-flex align-items-center gap-3">
                  <div class="small fw-bold ${r.prediction === 'Yes'? 'text-danger' : 'text-success'}">
                    ${r.prediction === 'Yes' ? '<i class="fas fa-exclamation-triangle"></i> Requiere mantenimiento' : '<i class="fas fa-check-circle"></i> Buen estado'}
                  </div>
                  <div class="small text-muted ms-2">${new Date(r.timestamp).toLocaleString()}</div>
                </div>
                <div class="mt-2 small text-muted">
                  <div><strong>Kilometraje:</strong> ${r.mileage} km — <strong>FuelEff:</strong> ${r.fuelEfficiency} km/L — <strong>Motor:</strong> ${r.engineSize} L</div>
                  <div><strong>Mantenimiento:</strong> ${r.maintenanceHistory} — <strong>ServiceCount:</strong> ${r.serviceHistory} — <strong>Accidentes:</strong> ${r.accidentHistory}</div>
                  <div><strong>Combustible:</strong> ${r.fuelType} — <strong>Transmisión:</strong> ${r.transmissionType}</div>
                  <div><strong>Llantas:</strong> ${r.tireCondition} — <strong>Frenos:</strong> ${r.brakeCondition} — <strong>Batería:</strong> ${r.batteryStatus}</div>
                </div>
              </div>
              <div class="text-end">
                <div class="small text-muted mt-2">ID: ${r.id || ''}</div>
                <div class="mt-3 d-flex gap-2 justify-content-end">
                  <button class="deleteBtn btn btn-link text-danger p-0 small" data-id="${r.id}">Borrar</button>
                </div>
              </div>
            </div>
          `;
        });

        // attach delete handlers
        document.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            // Reemplazado confirm() por SweetAlert2
            Swal.fire({
                title: '¿Estás seguro?',
                text: 'Esto borrará el reporte de predicción de forma permanente.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#667eea',
                confirmButtonText: 'Sí, borrar',
                cancelButtonText: 'Cancelar'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const id = btn.dataset.id;
                    try {
                        await fetch(`${API}/reports/${id}`, { method: 'DELETE' });
                        btn.closest('.report-item')?.remove();
                        showUserAlert('¡Borrado!', 'El reporte ha sido eliminado.', 'success');
                        // No hace falta recargar la lista si remove() funciona bien
                    } catch (e) {
                        showUserAlert('Error', 'Error borrando el reporte.', 'error');
                    }
                }
            });
          });
        });

      } catch (err) {
        historyList.innerHTML = '<p class="text-danger text-center py-4">Error cargando historial.</p>';
      }
    });

    // Clear all
    clearBtn.addEventListener('click', async () => {
      // Reemplazado confirm() por SweetAlert2
      Swal.fire({
          title: '¿Estás seguro?',
          text: 'Esto borrará TODO el historial de predicciones de forma permanente.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#667eea',
          confirmButtonText: 'Sí, limpiar todo',
          cancelButtonText: 'Cancelar'
      }).then(async (result) => {
          if (result.isConfirmed) {
              try {
                  await fetch(`${API}/reports/clear`, { method: 'DELETE' });
                  historyList.innerHTML = '<p class="text-center text-muted py-4">Historial vacío.</p>';
                  showUserAlert('¡Limpiado!', 'Todo el historial ha sido eliminado.', 'success');
              } catch (e) {
                  showUserAlert('Error', 'Error al limpiar el historial.', 'error');
              }
          }
      });
    });

    // Cargar nombre de usuario en navbar (pero NO sobrescribir 'Admin' por 'Cliente')
    document.addEventListener("DOMContentLoaded", () => {
      const nombreEl = document.getElementById("nombreUsuarioNavbar");
      // Si Thymeleaf ya puso administradorNombreUsuario, no hacemos fetch. Si está vacío, consultamos.
      if (nombreEl && (!nombreEl.textContent || nombreEl.textContent.trim() === '' || nombreEl.textContent.trim().toLowerCase() === '')) {
        fetch("/usuario/perfil")
          .then(response => response.json())
          .then(data => {
            // Solo setear si se obtiene un nombre distinto a 'Cliente' (evitar sobrescribir por error)
            if (data && data.nombreUsuario && data.nombreUsuario.toLowerCase() !== 'cliente') {
              nombreEl.textContent = data.nombreUsuario;
            }
          })
          .catch(err => console.error("Error al cargar nombre de usuario:", err));
      } else if (nombreEl && nombreEl.textContent.trim().toLowerCase() === 'cliente') {
        // Reemplazamos explícitamente "Cliente" por "Admin"
        nombreEl.textContent = 'Admin';
      }
    });

    // Reloj simple en navbar
    (function reloj() {
      const el = document.getElementById('reloj');
      if (!el) return;
      function fmt(n){ return n.toString().padStart(2,'0'); }
      setInterval(() => {
        const d = new Date();
        el.textContent = `${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())}`;
      }, 1000);
    })();
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.19.1/dist/sweetalert2.all.min.js"></script>
</body>
</html>